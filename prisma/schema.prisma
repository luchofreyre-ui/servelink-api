generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  phone            String?        @unique
  passwordHash     String
  role             Role           @default(customer)
  stripeCustomerId String?        @unique
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  bookings         Booking[]
  refreshTokens    RefreshToken[]
}

model RefreshToken {
  id           String         @id @default(cuid())
  userId       String
  tokenHash    String         @unique
  jti          String?        @unique
  expiresAt    DateTime
  revokedAt    DateTime?
  replacedById String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  replacedBy   RefreshToken?  @relation("RefreshRotation", fields: [replacedById], references: [id])
  replaces     RefreshToken[] @relation("RefreshRotation")
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Booking {
  id                    String         @id @default(cuid())
  customerId            String
  status                BookingStatus  @default(pending_payment)
  hourlyRateCents       Int
  estimatedHours        Float
  currency              String         @default("usd")
  stripePaymentIntentId String?        @unique
  stripeClientSecret    String?
  scheduledStart        DateTime?
  notes                 String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  customer              User           @relation(fields: [customerId], references: [id])
  addons                BookingAddon[]
  BookingEvent          BookingEvent[]

  @@index([customerId])
  @@index([status])
}

model SmsConfirmation {
  id          String    @id @default(cuid())
  code        String    @unique
  phone       String
  kind        String
  payloadJson String
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  respondedAt DateTime?
  expiresAt   DateTime
  rawReply    String?
}

model BookingAddon {
  id                    String   @id @default(cuid())
  bookingId             String
  smsCode               String   @unique
  type                  String
  payloadJson           String
  status                String   @default("approved")
  createdAt             DateTime @default(now())
  currency              String   @default("usd")
  priceCents            Int
  stripePaymentIntentId String?
  booking               Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([status])
  @@index([type])
}

model BookingEvent {
  id             String           @id
  bookingId      String
  type           BookingEventType @default(STATUS_CHANGED)
  fromStatus     BookingStatus?
  toStatus       BookingStatus?
  note           String?
  idempotencyKey String?
  createdAt      DateTime         @default(now())
  Booking        Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@unique([bookingId, idempotencyKey])
  @@index([bookingId, createdAt])
}

enum Role {
  customer
  fo
  admin
}

enum BookingStatus {
  pending_payment
  pending_dispatch
  offered
  assigned
  in_progress
  completed
  canceled
}

enum BookingEventType {
  CREATED
  STATUS_CHANGED
  NOTE
}
